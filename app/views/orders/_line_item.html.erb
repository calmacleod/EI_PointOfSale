<%# Partial for rendering a single order line (used in turbo streams) %>
<tr id="<%= dom_id(line) %>" class="group">
  <td class="px-4 py-2 text-xs font-mono text-muted align-top"><%= line.code %></td>
  <td class="px-4 py-2 text-sm text-body align-top">
    <div class="flex flex-col gap-1">
      <span><%= line.name %></span>
      
      <%# Per-line discounts with unit breakdown %>
      <% line.order_line_discounts.each do |line_discount| %>
        <% next if line_discount.auto_applied? && !line.order.draft? && line_discount.fully_excluded? %>
        
        <div class="flex flex-col gap-1 mt-1 p-1.5 rounded bg-surface-alt border border-theme">
          <div class="flex items-center justify-between text-xs">
            <span class="font-medium text-body"><%= line_discount.name %></span>
            <span class="text-green-600">-<%= number_to_currency(line_discount.calculated_amount) %></span>
          </div>
          
          <% if line_discount.auto_applied? && line.order.draft? %>
            <div class="flex flex-wrap gap-1 mt-1">
              <% line.quantity.times do |i| %>
                <% unit_has_discount = i >= line_discount.excluded_quantity %>
                <%= button_to unit_has_discount ? exclude_order_line_discount_path(line_discount) : restore_order_line_discount_path(line_discount),
                    method: :patch,
                    class: "w-6 h-6 rounded text-[10px] font-medium transition #{unit_has_discount ? 'bg-green-100 text-green-700 hover:bg-red-100 hover:text-red-700' : 'bg-gray-100 text-gray-400 hover:bg-green-100 hover:text-green-700'}",
                    data: { turbo_stream: true },
                    title: unit_has_discount ? "Remove discount from this unit" : "Apply discount to this unit" do %>
                  <%= i + 1 %>
                <% end %>
              <% end %>
            </div>
            <div class="flex items-center justify-between text-[10px] text-muted mt-1">
              <span><%= line_discount.applied_quantity %> of <%= line.quantity %> discounted</span>
              <% if line_discount.fully_excluded? %>
                <span class="text-red-600">Fully excluded</span>
              <% elsif line_discount.excluded_quantity > 0 %>
                <span class="text-yellow-600">Partially excluded</span>
              <% end %>
            </div>
          <% elsif line_discount.excluded_quantity > 0 %>
            <div class="text-[10px] text-muted">
              <%= line_discount.applied_quantity %> of <%= line.quantity %> discounted
              <% if line_discount.fully_excluded? %>
                <span class="text-red-600 ml-1">(Fully excluded)</span>
              <% else %>
                <span class="text-yellow-600 ml-1">(Partially excluded)</span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <% if line.sellable_type == "GiftCertificate" %>
        <span class="inline-block rounded bg-purple-100 px-1.5 py-0.5 font-mono text-[10px] text-purple-700 w-fit mt-1"><%= line.code %></span>
        <span class="text-[10px] text-muted italic">no tax</span>
      <% else %>
        <% if line.tax_rate > 0 %>
          <span class="text-[10px] text-muted mt-1"><%= (line.tax_rate * 100).round(1) %>% tax</span>
        <% end %>
      <% end %>
    </div>
  </td>
  <td class="px-4 py-2 text-center align-top">
    <% if line.order.draft? %>
      <div data-controller="inline-quantity" data-inline-quantity-url-value="<%= order_line_path(line) %>">
        <button type="button" class="inline-flex items-center justify-center rounded-md border border-theme bg-surface-alt px-2.5 py-0.5 text-sm font-medium text-body hover:bg-[var(--color-border)] transition"
                data-inline-quantity-target="display"
                data-action="click->inline-quantity#edit">
          <%= line.quantity %>
        </button>
        <input type="number" min="1" value="<%= line.quantity %>" autocomplete="off"
               class="hidden w-16 rounded-md border border-accent bg-surface px-2 py-0.5 text-center text-sm text-body focus:outline-none focus:ring-1 focus:ring-accent"
               data-inline-quantity-target="input"
               data-action="keydown->inline-quantity#handleKey blur->inline-quantity#cancel">
      </div>
    <% else %>
      <span class="text-sm text-body"><%= line.quantity %></span>
    <% end %>
  </td>
  <td class="px-4 py-2 text-right text-sm text-body align-top"><%= number_to_currency(line.unit_price) %></td>
  <td class="px-4 py-2 text-right text-sm font-medium text-body align-top">
    <%= number_to_currency(line.subtotal_before_discount) %>
    <% if line.discount_amount > 0 %>
      <div class="text-xs text-green-600">-<%= number_to_currency(line.discount_amount) %></div>
      <div class="text-xs font-medium"><%= number_to_currency(line.line_total - line.tax_amount) %></div>
    <% end %>
  </td>
  <td class="px-4 py-2 text-center align-top">
    <div class="flex items-center justify-center gap-1">
      <% if line.sellable.present? %>
        <button type="button"
                class="text-muted opacity-0 group-hover:opacity-100 hover:text-accent transition"
                title="Preview <%= line.sellable_type.downcase %>"
                data-action="click->item-preview#open"
                data-sellable-type="<%= line.sellable_type %>"
                data-sellable-id="<%= line.sellable_id %>">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
        </button>
      <% end %>
      <% if line.order.draft? %>
        <%= button_to order_line_path(line), method: :delete, class: "text-muted opacity-0 group-hover:opacity-100 hover:text-red-500 transition", data: { turbo_stream: true } do %>
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        <% end %>
      <% end %>
    </div>
  </td>
</tr>
