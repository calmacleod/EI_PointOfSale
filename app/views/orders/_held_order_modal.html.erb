<div id="<%= dom_id(order, :modal) %>"
     data-modal-target="modal"
     class="modal-overlay fixed inset-0 z-[60] hidden"
     role="dialog"
     aria-modal="true"
     aria-labelledby="<%= dom_id(order, :modal_title) %>">
  <%# Backdrop %>
  <div data-action="click->modal#close"
       class="fixed inset-0 bg-black/50"></div>

  <%# Modal container %>
  <div class="fixed inset-0 flex items-start justify-center p-4 pt-[10vh] pointer-events-none">
    <div class="w-full max-w-lg rounded-lg border border-theme bg-surface overflow-hidden pointer-events-auto shadow-xl"
         role="document">

      <%# Header %>
      <div class="flex items-center justify-between border-b border-theme bg-surface-alt px-4 py-3">
        <div>
          <h2 id="<%= dom_id(order, :modal_title) %>" class="text-base font-semibold text-body">
            Order <%= order.number %>
          </h2>
          <p class="text-xs text-muted mt-0.5">
            Held <%= time_ago_in_words(order.held_at) %> ago by <%= order.created_by&.name || order.created_by&.email_address %>
          </p>
        </div>
        <button type="button"
                data-action="click->modal#close"
                class="rounded-md p-1 text-muted hover:bg-[var(--color-border)] hover:text-body">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <%# Content %>
      <div class="max-h-[60vh] overflow-y-auto">
        <%# Customer & Summary %>
        <div class="border-b border-theme px-4 py-3">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <span class="text-xs font-medium text-muted uppercase tracking-wider">Customer</span>
              <p class="text-sm text-body mt-0.5">
                <% if order.customer %>
                  <%= link_to order.customer.name, customer_path(order.customer),
                              class: "text-accent hover:underline",
                              data: { turbo_frame: "_top" } %>
                <% else %>
                  <span class="text-muted italic">Quick Sale</span>
                <% end %>
              </p>
            </div>
            <div>
              <span class="text-xs font-medium text-muted uppercase tracking-wider">Total Items</span>
              <p class="text-sm text-body mt-0.5"><%= order.order_lines.sum(:quantity) %> items</p>
            </div>
            <div>
              <span class="text-xs font-medium text-muted uppercase tracking-wider">Tax Status</span>
              <p class="text-sm text-body mt-0.5">
                <% if order.tax_exempt %>
                  <span class="inline-flex items-center rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-medium text-yellow-800">
                    Tax Exempt
                  </span>
                <% else %>
                  Taxable
                <% end %>
              </p>
            </div>
            <div>
              <span class="text-xs font-medium text-muted uppercase tracking-wider">Order Total</span>
              <p class="text-lg font-semibold text-body mt-0.5"><%= number_to_currency(order.total) %></p>
            </div>
          </div>
        </div>

        <%# Line Items %>
        <% if order.order_lines.any? %>
          <div class="border-b border-theme">
            <div class="bg-surface-alt px-4 py-2">
              <span class="text-xs font-medium text-muted uppercase tracking-wider">Line Items</span>
            </div>
            <table class="w-full text-xs">
              <thead>
                <tr class="border-b border-theme">
                  <th class="px-4 py-1.5 text-left font-medium text-muted">Item</th>
                  <th class="px-4 py-1.5 text-center font-medium text-muted">Qty</th>
                  <th class="px-4 py-1.5 text-right font-medium text-muted">Price</th>
                  <th class="px-4 py-1.5 text-right font-medium text-muted">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[var(--color-border)]">
                <% order.order_lines.each do |line| %>
                  <tr>
                    <td class="px-4 py-1.5 text-body">
                      <div class="font-medium"><%= line.name %></div>
                      <% if line.code.present? %>
                        <div class="font-mono text-muted text-[10px]"><%= line.code %></div>
                      <% end %>
                    </td>
                    <td class="px-4 py-1.5 text-center text-body"><%= line.quantity %></td>
                    <td class="px-4 py-1.5 text-right text-body"><%= number_to_currency(line.unit_price) %></td>
                    <td class="px-4 py-1.5 text-right font-medium text-body"><%= number_to_currency(line.line_total) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>

        <%# Order Totals Breakdown %>
        <div class="border-b border-theme px-4 py-3">
          <div class="space-y-1 text-xs">
            <div class="flex justify-between">
              <span class="text-muted">Subtotal</span>
              <span class="text-body"><%= number_to_currency(order.subtotal) %></span>
            </div>
            <% if order.discount_total > 0 %>
              <div class="flex justify-between">
                <span class="text-muted">Discounts</span>
                <span class="text-green-600">-<%= number_to_currency(order.discount_total) %></span>
              </div>
            <% end %>
            <% if order.tax_total > 0 %>
              <div class="flex justify-between">
                <span class="text-muted">Tax</span>
                <span class="text-body"><%= number_to_currency(order.tax_total) %></span>
              </div>
            <% end %>
            <div class="flex justify-between border-t border-[var(--color-border)] pt-1 mt-1">
              <span class="font-medium text-body">Total</span>
              <span class="font-semibold text-body"><%= number_to_currency(order.total) %></span>
            </div>
          </div>
        </div>

        <%# Notes %>
        <% if order.notes.present? %>
          <div class="border-b border-theme px-4 py-3">
            <span class="text-xs font-medium text-muted uppercase tracking-wider">Notes</span>
            <p class="text-sm text-body mt-1"><%= order.notes %></p>
          </div>
        <% end %>
      </div>

      <%# Actions Footer %>
      <div class="flex items-center justify-end gap-2 border-t border-theme bg-surface-alt px-4 py-3">
        <%= button_to cancel_order_path(order),
            method: :delete,
            class: "rounded-md border border-[var(--color-error-text)] px-3 py-1.5 text-xs font-medium text-[var(--color-error-text)] hover:bg-[var(--color-error-bg)] transition",
            data: { turbo_confirm: "Cancel order #{order.number}? This cannot be undone.", turbo_frame: "_top" } do %>
          Cancel Order
        <% end %>
        <%= link_to register_path(order_id: order.id),
            class: "rounded-md bg-accent px-3 py-1.5 text-xs font-medium text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)] transition",
            data: { turbo_frame: "_top" } do %>
          Resume Order
        <% end %>
      </div>

    </div>
  </div>
</div>
