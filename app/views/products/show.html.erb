<% content_for :title, @product.name %>
<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Products", products_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted"><%= @product.name %></li>
<% end %>

<div class="mx-auto max-w-5xl">
  <%= render "shared/page_header", title: @product.name, description: "Product details, variants, and inventory." do %>
    <div class="flex items-center gap-2">
      <%= link_to "Back to products", products_path, class: "inline-flex min-h-[44px] items-center justify-center rounded-lg border border-theme bg-surface px-4 py-3 text-base font-semibold text-body hover:bg-[var(--color-border)]/30", data: { turbo_prefetch: true } %>
      <% if can? :update, @product %>
        <%= link_to "Edit", edit_product_path(@product),
            class: "inline-flex min-h-[44px] items-center justify-center rounded-lg bg-accent px-4 py-3 text-base font-semibold text-[color:var(--color-page)] shadow-sm hover:bg-[var(--color-accent-hover)]",
            data: { turbo_prefetch: true } %>
      <% end %>
    </div>
  <% end %>

  <section class="mt-6 overflow-hidden rounded-xl border border-theme bg-surface shadow-sm" aria-labelledby="product-details-heading">
    <div class="border-b border-theme bg-[var(--color-border)]/20 px-6 py-3">
      <h2 id="product-details-heading" class="text-base font-semibold text-body">Details</h2>
      <p class="mt-0.5 text-sm text-muted">Product information and classification</p>
    </div>
    <dl class="divide-y divide-[var(--color-border)]">
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Name</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.name %></dd>
      </div>
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Tax code</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.tax_code&.code || "—" %></dd>
      </div>
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Supplier</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.supplier&.name || "—" %></dd>
      </div>
      <% if @product.categories.any? %>
        <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
          <dt class="text-sm font-medium text-muted">Categories</dt>
          <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.categories.pluck(:name).join(", ") %></dd>
        </div>
      <% end %>
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Product URL</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0">
          <%= @product.product_url.present? ? link_to(@product.product_url, @product.product_url, class: "text-accent hover:underline break-all", target: "_blank", rel: "noopener") : "—" %>
        </dd>
      </div>
      <% if @product.added_by.present? %>
        <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
          <dt class="text-sm font-medium text-muted">Added by</dt>
          <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.added_by.email_address %></dd>
        </div>
      <% end %>
    </dl>
  </section>

  <section class="mt-6 overflow-hidden rounded-xl border border-theme bg-surface shadow-sm" aria-labelledby="product-meta-heading">
    <div class="border-b border-theme bg-[var(--color-border)]/20 px-6 py-3">
      <h2 id="product-meta-heading" class="text-base font-semibold text-body">Record info</h2>
      <p class="mt-0.5 text-sm text-muted">Timestamps</p>
    </div>
    <dl class="divide-y divide-[var(--color-border)]">
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Created</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.created_at.strftime("%b %-d, %Y at %-I:%M %p") %></dd>
      </div>
      <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
        <dt class="text-sm font-medium text-muted">Last updated</dt>
        <dd class="mt-1 text-base text-body sm:col-span-2 sm:mt-0"><%= @product.updated_at.strftime("%b %-d, %Y at %-I:%M %p") %></dd>
      </div>
    </dl>
  </section>

  <section class="mt-8" aria-labelledby="variants-heading">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 id="variants-heading" class="text-lg font-semibold text-body">Variants</h2>
        <p class="mt-0.5 text-sm text-muted">SKUs and inventory for this product</p>
      </div>
      <% if can? :create, ProductVariant %>
        <%= link_to "Add variant", new_product_product_variant_path(@product),
            class: "inline-flex min-h-[40px] items-center justify-center rounded-lg bg-accent px-3 py-2 text-sm font-semibold text-[color:var(--color-page)] shadow-sm hover:bg-[var(--color-accent-hover)]",
            data: { turbo_prefetch: true } %>
      <% end %>
    </div>

    <div class="overflow-x-auto rounded-lg border border-theme bg-surface">
      <table class="min-w-full divide-y divide-[var(--color-border)]">
        <thead class="bg-[var(--color-border)]/30">
          <tr>
            <th class="px-4 py-3 text-left text-sm font-medium uppercase tracking-wider text-muted">Code</th>
            <th class="px-4 py-3 text-left text-sm font-medium uppercase tracking-wider text-muted">Name</th>
            <th class="px-4 py-3 text-left text-sm font-medium uppercase tracking-wider text-muted">Price</th>
            <th class="px-4 py-3 text-left text-sm font-medium uppercase tracking-wider text-muted">Stock</th>
            <th class="px-4 py-3 text-right text-sm font-medium uppercase tracking-wider text-muted"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)] bg-surface">
          <% @product.variants.kept.each do |variant| %>
            <tr>
              <td class="px-4 py-3 text-sm font-medium text-body">
                <% if can? :read, variant %>
                  <%= link_to variant.code, product_product_variant_path(@product, variant), class: "text-accent hover:underline", data: { turbo_prefetch: true } %>
                <% else %>
                  <%= variant.code %>
                <% end %>
              </td>
              <td class="px-4 py-3 text-sm text-body"><%= variant.name.presence || "—" %></td>
              <td class="px-4 py-3 text-sm text-body"><%= number_to_currency(variant.selling_price) || "—" %></td>
              <td class="px-4 py-3 text-sm text-body"><%= variant.stock_level || "—" %></td>
              <td class="px-4 py-3 text-right text-sm">
                <% if can? :update, variant %>
                  <%= link_to "Edit", edit_product_product_variant_path(@product, variant),
                      class: "font-medium text-accent hover:opacity-80",
                      data: { turbo_prefetch: true } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @product.variants.kept.empty? %>
      <div class="mt-4 rounded-xl border border-theme bg-[var(--color-border)]/10 px-6 py-8 text-center">
        <p class="text-base text-muted">No variants yet. Add one to make this product sellable.</p>
        <% if can? :create, ProductVariant %>
          <%= link_to "Add variant", new_product_product_variant_path(@product),
              class: "mt-4 inline-flex min-h-[40px] items-center justify-center rounded-lg bg-accent px-4 py-2 text-sm font-semibold text-[color:var(--color-page)] shadow-sm hover:bg-[var(--color-accent-hover)]",
              data: { turbo_prefetch: true } %>
        <% end %>
      </div>
    <% end %>
  </section>
</div>
