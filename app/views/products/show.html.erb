<% content_for :title, @product.name %>
<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Products", products_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted"><%= @product.name %></li>
<% end %>

<div>
  <%= render "shared/page_header", title: @product.name, description: "Product details, variants, and inventory." do %>
    <div class="flex items-center gap-1.5">
      <%= link_to "Back to products", products_path, class: "inline-flex min-h-[30px] items-center justify-center rounded-md border border-theme bg-surface px-2.5 py-1 text-sm font-semibold text-body hover:bg-[var(--color-border)]/30", data: { turbo_prefetch: true } %>
      <% if can? :update, @product %>
        <%= link_to "Edit", edit_product_path(@product),
            class: "inline-flex min-h-[30px] items-center justify-center rounded-md bg-accent px-2.5 py-1 text-sm font-semibold text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)]",
            data: { turbo_prefetch: true } %>
      <% end %>
    </div>
  <% end %>

  <div class="mt-2 grid grid-cols-1 gap-2 lg:grid-cols-2">
    <section class="overflow-hidden rounded-lg border border-theme bg-surface" aria-labelledby="product-details-heading">
      <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
        <h2 id="product-details-heading" class="text-sm font-semibold text-body">Details</h2>
        <p class="text-xs text-muted">Product information and classification</p>
      </div>
      <dl class="divide-y divide-[var(--color-border)]">
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Name</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @product.name %></dd>
        </div>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Tax code</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @product.tax_code&.code || "—" %></dd>
        </div>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Supplier</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @product.supplier&.name || "—" %></dd>
        </div>
        <% if @product.categories.any? %>
          <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
            <dt class="text-xs font-medium text-muted">Categories</dt>
            <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @product.categories.pluck(:name).join(", ") %></dd>
          </div>
        <% end %>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Product URL</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0">
            <%= @product.product_url.present? ? link_to(@product.product_url, @product.product_url, class: "text-accent hover:underline break-all", target: "_blank", rel: "noopener") : "—" %>
          </dd>
        </div>
      </dl>
    </section>

    <section class="overflow-hidden rounded-lg border border-theme bg-surface" aria-labelledby="product-meta-heading">
      <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
        <h2 id="product-meta-heading" class="text-sm font-semibold text-body">Record info</h2>
        <p class="text-xs text-muted">Timestamps and provenance</p>
      </div>
      <dl class="divide-y divide-[var(--color-border)]">
        <% if @product.added_by.present? %>
          <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
            <dt class="text-xs font-medium text-muted">Added by</dt>
            <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @product.added_by.email_address %></dd>
          </div>
        <% end %>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Created</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= local_time(@product.created_at, format: :long) %></dd>
        </div>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted">Last updated</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= local_time(@product.updated_at, format: :long) %></dd>
        </div>
      </dl>
    </section>
  </div>

  <section class="mt-2" aria-labelledby="variants-heading">
    <div class="flex items-center justify-between mb-1.5">
      <div>
        <h2 id="variants-heading" class="text-sm font-semibold text-body">Variants</h2>
        <p class="text-xs text-muted">SKUs and inventory for this product</p>
      </div>
      <% if can? :create, ProductVariant %>
        <%= link_to "Add variant", new_product_product_variant_path(@product),
            class: "inline-flex min-h-[30px] items-center justify-center rounded-md bg-accent px-2.5 py-1 text-sm font-semibold text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)]",
            data: { turbo_prefetch: true } %>
      <% end %>
    </div>

    <div class="overflow-x-auto rounded-lg border border-theme bg-surface">
      <table class="min-w-full divide-y divide-[var(--color-border)]">
        <thead class="bg-surface-alt">
          <tr>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Code</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Name</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Price</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Stock</th>
            <th class="px-3 py-1 text-right text-xs font-medium uppercase tracking-wider text-muted"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)] bg-surface">
          <% @product.variants.kept.each do |variant| %>
            <tr>
              <td class="px-3 py-1.5 text-sm font-medium text-body">
                <% if can? :read, variant %>
                  <%= link_to variant.code, product_product_variant_path(@product, variant), class: "text-accent hover:underline", data: { turbo_prefetch: true } %>
                <% else %>
                  <%= variant.code %>
                <% end %>
              </td>
              <td class="px-3 py-1.5 text-sm text-body"><%= variant.name.presence || "—" %></td>
              <td class="px-3 py-1.5 text-sm text-body"><%= number_to_currency(variant.selling_price) || "—" %></td>
              <td class="px-3 py-1.5 text-sm text-body"><%= variant.stock_level || "—" %></td>
              <td class="px-3 py-1.5 text-right text-sm">
                <% if can? :update, variant %>
                  <%= link_to "Edit", edit_product_product_variant_path(@product, variant),
                      class: "font-medium text-accent hover:opacity-80",
                      data: { turbo_prefetch: true } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <% if @product.variants.kept.empty? %>
      <div class="mt-2 rounded-lg border border-theme bg-[var(--color-border)]/10 px-3 py-3 text-center">
        <p class="text-sm text-muted">No variants yet. Add one to make this product sellable.</p>
        <% if can? :create, ProductVariant %>
          <%= link_to "Add variant", new_product_product_variant_path(@product),
              class: "mt-1.5 inline-flex min-h-[30px] items-center justify-center bg-accent px-2.5 py-1 text-sm font-semibold text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)]",
              data: { turbo_prefetch: true } %>
        <% end %>
      </div>
    <% end %>
  </section>

  <%= render "shared/audit_trail", auditable: @product %>
</div>
