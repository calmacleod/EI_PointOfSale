<% content_for :title, "Audit trail" %>
<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Admin settings", admin_settings_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted">Audit trail</li>
<% end %>

<div class="lg:flex lg:min-h-0 lg:flex-1 lg:flex-col">
  <%= render "shared/page_header", title: "Audit trail", description: "All changes across the application." do %>
    <%= link_to "Back to admin settings", admin_settings_path,
        class: "inline-flex min-h-[30px] items-center justify-center border border-theme bg-surface px-2.5 py-1 text-sm font-medium text-body hover:bg-[var(--color-border)]/30",
        data: { turbo_prefetch: true } %>
  <% end %>

  <div class="mt-2 flex flex-col gap-2 lg:min-h-0 lg:flex-1">
    <%= render "shared/filter_bar", config: @filter_config, saved_queries: @saved_queries %>

    <%= render "shared/data_table", config: @filter_config, records: @audits, pagy: @pagy,
               empty_message: "No audit events yet." do |t| %>
      <% t.cell(:created_at) { |audit| content_tag(:span, local_time(audit.created_at, format: :short), class: "text-muted") } %>
      <% t.cell(:action) { |audit| content_tag(:span, audit.action.capitalize, class: "font-medium capitalize") } %>
      <% t.cell(:auditable_type) { |audit| audit.auditable_type } %>
      <% t.cell(:record) { |audit|
           path = audit_auditable_path(audit)
           if path
             link_to audit_auditable_label(audit), path, class: "text-accent hover:underline", data: { turbo_frame: "_top", turbo_prefetch: true }
           else
             audit_auditable_label(audit)
           end
         } %>
      <% t.cell(:user) { |audit|
           if audit.user.present?
             audit.user.respond_to?(:email_address) ? audit.user.email_address : audit.user.to_s
           else
             "—"
           end
         } %>
      <% t.cell(:details) { |audit|
           link_to admin_audit_path(audit), class: "inline-flex items-center justify-center text-accent hover:opacity-70", aria: { label: "View changes" }, data: { turbo_frame: "_top", turbo_prefetch: true } do
             tag.svg(class: "h-4 w-4", fill: "none", stroke: "currentColor", viewBox: "0 0 24 24", aria: { hidden: true }) do
               safe_join([
                 tag.path("stroke-linecap": "round", "stroke-linejoin": "round", "stroke-width": "2", d: "M15 12a3 3 0 11-6 0 3 3 0 016 0z"),
                 tag.path("stroke-linecap": "round", "stroke-linejoin": "round", "stroke-width": "2", d: "M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z")
               ])
             end
           end
         } %>
    <% end %>
  </div>
</div>
