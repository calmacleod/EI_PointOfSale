<% content_for :title, "Data Import" %>
<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Admin settings", admin_settings_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted">Data Import</li>
<% end %>

<div class="mx-auto max-w-3xl">
  <%= render "shared/page_header", title: "Data Import", description: "Import legacy stock data from a CSV file." %>

  <%# ── Upload form ──────────────────────────────────────────────── %>
  <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
    <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
      <h2 class="text-sm font-semibold text-body">Upload CSV</h2>
      <p class="text-xs text-muted">Select a stock CSV file to preview or import directly.</p>
    </div>
    <%= form_tag admin_imports_path, multipart: true, class: "px-3 py-2.5 space-y-2" do %>
      <div>
        <label for="file" class="text-sm font-medium text-body">CSV file</label>
        <%= file_field_tag :file, accept: ".csv",
            class: "mt-1 block w-full text-sm text-body file:mr-2 file:border file:border-theme file:bg-surface-alt file:px-2.5 file:py-1 file:text-sm file:font-medium file:text-body hover:file:bg-[var(--color-border)]/30" %>
        <p class="mt-0.5 text-xs text-muted">Expected format: Stock_Code, Product_Name, Selling_Price, Purchase_Price, etc.</p>
      </div>
      <div class="flex gap-2">
        <%= submit_tag "Preview", name: "preview", value: "1",
            class: "inline-flex min-h-[30px] items-center justify-center rounded-md border border-theme bg-surface px-2.5 py-1 text-sm font-medium text-body hover:bg-[var(--color-border)]/30 cursor-pointer" %>
        <%= submit_tag "Import now", name: "import", value: "1",
            data: { turbo_confirm: "This will start importing the CSV immediately. Continue?" },
            class: "inline-flex min-h-[30px] items-center justify-center rounded-md bg-accent px-2.5 py-1 text-sm font-medium text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)] cursor-pointer" %>
      </div>
    <% end %>
  </section>

  <%# ── Recent imports ───────────────────────────────────────────── %>
  <% if @recent_imports.any? %>
    <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
      <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
        <h2 class="text-sm font-semibold text-body">Recent imports</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-[var(--color-border)]">
          <thead class="bg-surface-alt">
            <tr>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">File</th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Status</th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Progress</th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Date</th>
              <th class="px-3 py-1 text-right text-xs font-medium uppercase tracking-wider text-muted"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[var(--color-border)] bg-surface">
            <% @recent_imports.each do |import| %>
              <tr>
                <td class="px-3 py-1.5 text-sm text-body"><%= import.file_name %></td>
                <td class="px-3 py-1.5 text-sm">
                  <% case import.status %>
                  <% when "completed" %>
                    <%= status_chip("Completed", :success) %>
                  <% when "processing" %>
                    <%= status_chip("Processing", :info) %>
                  <% when "failed" %>
                    <%= status_chip("Failed", :error) %>
                  <% else %>
                    <%= status_chip("Pending", :neutral) %>
                  <% end %>
                </td>
                <td class="px-3 py-1.5 text-sm text-muted"><%= import.processed_rows %>/<%= import.total_rows || "?" %></td>
                <td class="px-3 py-1.5 text-sm text-muted"><%= local_time(import.created_at, format: :short) %></td>
                <td class="px-3 py-1.5 text-right text-sm">
                  <%= link_to "View", admin_import_path(import), class: "font-medium text-accent hover:opacity-80" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </section>
  <% end %>
</div>
