<% content_for :title, "Import Preview" %>
<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Admin settings", admin_settings_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Data Import", new_admin_import_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted">Preview</li>
<% end %>

<div class="mx-auto max-w-4xl">
  <%= render "shared/page_header", title: "Import Preview", description: "Review the data before importing." %>

  <%# ── Summary stats ────────────────────────────────────────────── %>
  <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
    <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
      <h2 class="text-sm font-semibold text-body">Summary</h2>
      <p class="text-xs text-muted"><%= @data_import.file_name %></p>
    </div>
    <dl class="divide-y divide-[var(--color-border)]">
      <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
        <dt class="text-xs font-medium text-muted">Total rows</dt>
        <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= number_with_delimiter(@preview[:total_rows]) %></dd>
      </div>
      <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
        <dt class="text-xs font-medium text-muted">Categories detected</dt>
        <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @preview[:category_count] %></dd>
      </div>
      <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
        <dt class="text-xs font-medium text-muted">Suppliers detected</dt>
        <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @preview[:supplier_count] %></dd>
      </div>
      <% if @preview[:duplicate_codes] > 0 %>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted text-[var(--color-warning-text)]">Duplicate codes</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @preview[:duplicate_codes] %> (last occurrence will be kept)</dd>
        </div>
      <% end %>
      <% if @preview[:blank_codes] > 0 %>
        <div class="px-3 py-1.5 sm:grid sm:grid-cols-3 sm:gap-3">
          <dt class="text-xs font-medium text-muted text-[var(--color-warning-text)]">Blank codes</dt>
          <dd class="mt-0.5 text-sm text-body sm:col-span-2 sm:mt-0"><%= @preview[:blank_codes] %> (will be skipped)</dd>
        </div>
      <% end %>
    </dl>
  </section>

  <%# ── Categories ───────────────────────────────────────────────── %>
  <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
    <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
      <h2 class="text-sm font-semibold text-body">Categories</h2>
    </div>
    <div class="px-3 py-2 flex flex-wrap gap-1.5">
      <% @preview[:categories].each do |cat| %>
        <span class="rounded-full bg-surface-alt px-2 py-0.5 text-xs font-medium text-body border border-theme"><%= cat %></span>
      <% end %>
    </div>
  </section>

  <%# ── Suppliers ────────────────────────────────────────────────── %>
  <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
    <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
      <h2 class="text-sm font-semibold text-body">Suppliers</h2>
    </div>
    <div class="px-3 py-2 flex flex-wrap gap-1.5">
      <% @preview[:suppliers].each do |sup| %>
        <span class="rounded-full bg-surface-alt px-2 py-0.5 text-xs font-medium text-body border border-theme"><%= sup %></span>
      <% end %>
    </div>
  </section>

  <%# ── Sample rows ──────────────────────────────────────────────── %>
  <section class="mt-2 overflow-hidden rounded-lg border border-theme bg-surface">
    <div class="border-b border-theme bg-surface-alt px-3 py-1.5">
      <h2 class="text-sm font-semibold text-body">Sample rows (first 5)</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-[var(--color-border)]">
        <thead class="bg-surface-alt">
          <tr>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Code</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Name</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Price</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Stock</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Category</th>
            <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Supplier</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-[var(--color-border)] bg-surface">
          <% @preview[:sample_rows].each do |row| %>
            <tr>
              <td class="px-3 py-1.5 text-xs font-mono text-body"><%= row["Stock_Code"] %></td>
              <td class="px-3 py-1.5 text-xs text-body max-w-[200px] truncate"><%= row["Product_Name"] %></td>
              <td class="px-3 py-1.5 text-xs text-body"><%= number_to_currency(row["Selling_Price"]) %></td>
              <td class="px-3 py-1.5 text-xs text-body"><%= row["Stock_Level"] %></td>
              <td class="px-3 py-1.5 text-xs text-body"><%= row["Stock_Cat"] %></td>
              <td class="px-3 py-1.5 text-xs text-body"><%= row["Supplier"] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </section>

  <%# ── Execute button ───────────────────────────────────────────── %>
  <div class="mt-2 flex items-center justify-between">
    <%= link_to "Back", new_admin_import_path,
        class: "inline-flex min-h-[30px] items-center justify-center rounded-md border border-theme bg-surface px-2.5 py-1 text-sm font-medium text-body hover:bg-[var(--color-border)]/30" %>
    <% if @data_import.persisted? %>
      <%= button_to "Execute import", execute_admin_import_path(@data_import),
          method: :patch,
          data: { turbo_confirm: "This will import #{number_with_delimiter(@preview[:total_rows])} rows. This may take several minutes. Continue?" },
          class: "inline-flex min-h-[30px] items-center justify-center rounded-md bg-accent px-2.5 py-1 text-sm font-semibold text-[color:var(--color-page)] hover:bg-[var(--color-accent-hover)]" %>
    <% end %>
  </div>
</div>
