<% content_for :title, "Reports" %>

<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted">Reports</li>
<% end %>

<div class="lg:flex lg:min-h-0 lg:flex-1 lg:flex-col">
  <%= render "shared/page_header", title: "Reports", description: "Generate and view business reports." %>

  <%# ── Available report templates ──────────────────────────────────── %>
  <% if can? :create, Report %>
    <div class="mt-2 rounded-lg border border-theme bg-surface p-2.5">
      <h2 class="text-sm font-semibold text-body">New report</h2>
      <p class="mt-0.5 text-xs text-muted">Choose a report template to generate a new report.</p>

      <div class="mt-2 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3">
        <% @templates.each do |template| %>
          <%= link_to new_report_path(template: template.key),
              class: "group block rounded-lg border border-theme p-2.5 transition hover:border-[var(--color-accent)]",
              data: { turbo_prefetch: true } do %>
            <h3 class="text-sm font-semibold text-body group-hover:text-accent"><%= template.title %></h3>
            <p class="mt-0.5 text-xs text-muted"><%= template.description %></p>
            <p class="mt-1.5 text-xs font-medium text-accent">Generate →</p>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# ── Previously generated reports ────────────────────────────────── %>
  <div class="mt-2 flex flex-col gap-2 lg:min-h-0 lg:flex-1">
    <h2 class="text-sm font-semibold text-body">Generated reports</h2>

    <%= render "shared/table_filters",
        search_path: reports_path,
        turbo_frame: "reports_table",
        label: "Search reports",
        placeholder: "Search reports…",
        filter_params: %w[q status report_type] do |f| %>
      <label for="reports_table_status" class="sr-only">Status</label>
      <%= f.select :status,
          [
            [ "All statuses", "" ],
            [ "Completed", "completed" ],
            [ "Processing", "processing" ],
            [ "Pending", "pending" ],
            [ "Failed", "failed" ]
          ],
          { selected: params[:status] },
          {
            id: "reports_table_status",
            class: "input-field min-h-[30px] w-36 cursor-pointer text-sm",
            data: { action: "change->table-search#handleChange" }
          } %>
      <label for="reports_table_type" class="sr-only">Report type</label>
      <%= f.select :report_type,
          [ [ "All types", "" ] ] + ReportTemplate.all.map { |t| [ t.title, t.key ] },
          { selected: params[:report_type] },
          {
            id: "reports_table_type",
            class: "input-field min-h-[30px] w-44 cursor-pointer text-sm",
            data: { action: "change->table-search#handleChange" }
          } %>
    <% end %>

    <%= turbo_frame_tag "reports_table", class: "lg:flex lg:min-h-0 lg:flex-1 lg:flex-col" do %>
      <div class="overflow-x-auto rounded-lg border border-theme bg-surface lg:flex-1 lg:overflow-y-auto">
        <table class="min-w-full divide-y divide-[var(--color-border)]">
          <thead class="bg-surface-alt lg:sticky lg:top-0 lg:z-10">
            <tr>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted"><%= sort_link "Title", :title %></th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted"><%= sort_link "Type", :report_type %></th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted"><%= sort_link "Status", :status %></th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted">Generated by</th>
              <th class="px-3 py-1 text-left text-xs font-medium uppercase tracking-wider text-muted"><%= sort_link "Created", :created_at %></th>
              <th class="px-3 py-1 text-right text-xs font-medium uppercase tracking-wider text-muted"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-[var(--color-border)] bg-surface">
            <% @reports.each do |report| %>
              <tr>
                <td class="px-3 py-1.5 text-sm font-medium text-body">
                  <%= link_to report.title.truncate(50), report_path(report),
                      class: "text-accent hover:underline",
                      data: { turbo_frame: "_top", turbo_prefetch: true } %>
                </td>
                <td class="px-3 py-1.5 text-sm text-body">
                  <%= report.template&.title || report.report_type.titleize %>
                </td>
                <td class="px-3 py-1.5 text-sm">
                  <%= render_report_status_badge(report) %>
                </td>
                <td class="px-3 py-1.5 text-sm text-muted">
                  <%= report.generated_by.name || report.generated_by.email_address %>
                </td>
                <td class="px-3 py-1.5 text-sm text-muted">
                  <%= time_tag report.created_at, report.created_at.strftime("%b %d, %Y %l:%M %p") %>
                </td>
                <td class="px-3 py-1.5 text-right text-sm">
                  <%= link_to "View", report_path(report),
                      class: "font-medium text-accent hover:underline",
                      data: { turbo_frame: "_top", turbo_prefetch: true } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <% if @reports.empty? %>
        <p class="mt-2 text-sm text-muted">No reports match your filters. Generate one from the templates above.</p>
      <% end %>

      <%= render "shared/pagy_nav" %>
    <% end %>
  </div>
</div>
