<% content_for :title, "Reports" %>

<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted">Reports</li>
<% end %>

<div class="lg:flex lg:min-h-0 lg:flex-1 lg:flex-col">
  <%= render "shared/page_header", title: "Reports", description: "Generate and view business reports." %>

  <%# ── Available report templates ──────────────────────────────────── %>
  <% if can? :create, Report %>
    <div class="mt-2 rounded-lg border border-theme bg-surface p-2.5">
      <h2 class="text-sm font-semibold text-body">New report</h2>
      <p class="mt-0.5 text-xs text-muted">Choose a report template to generate a new report.</p>

      <div class="mt-2 grid grid-cols-1 gap-2 sm:grid-cols-2 lg:grid-cols-3">
        <% @templates.each do |template| %>
          <%= link_to new_report_path(template: template.key),
              class: "group block rounded-lg border border-theme p-2.5 transition hover:border-[var(--color-accent)]",
              data: { turbo_prefetch: true } do %>
            <h3 class="text-sm font-semibold text-body group-hover:text-accent"><%= template.title %></h3>
            <p class="mt-0.5 text-xs text-muted"><%= template.description %></p>
            <p class="mt-1.5 text-xs font-medium text-accent">Generate →</p>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# ── Previously generated reports ────────────────────────────────── %>
  <div class="mt-2 flex flex-col gap-2 lg:min-h-0 lg:flex-1">
    <h2 class="text-sm font-semibold text-body">Generated reports</h2>

    <%= render "shared/filter_bar", config: @filter_config, saved_queries: @saved_queries %>

    <%= render "shared/data_table", config: @filter_config, records: @reports, pagy: @pagy,
               empty_message: "No reports match your filters. Generate one from the templates above." do |t| %>
      <% t.cell(:title) { |report| link_to report.title.truncate(50), report_path(report), class: "font-medium text-accent hover:underline", data: { turbo_frame: "_top", turbo_prefetch: true } } %>
      <% t.cell(:report_type) { |report| report.template&.title || report.report_type.titleize } %>
      <% t.cell(:status) { |report| render_report_status_badge(report) } %>
      <% t.cell(:generated_by) { |report| report.generated_by.name || report.generated_by.email_address } %>
      <% t.cell(:created_at) { |report| time_tag report.created_at, report.created_at.strftime("%b %d, %Y %l:%M %p") } %>
      <% t.cell(:actions) { |report| link_to("View", report_path(report), class: "font-medium text-accent hover:underline", data: { turbo_frame: "_top", turbo_prefetch: true }) } %>
    <% end %>
  </div>
</div>
