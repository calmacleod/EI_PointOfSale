<% content_for :title, @report.title %>

<% content_for :breadcrumbs do %>
  <li><%= link_to "Dashboard", root_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li><%= link_to "Reports", reports_path, class: "font-medium text-body hover:text-accent" %></li>
  <li><span aria-hidden="true">›</span></li>
  <li aria-current="page" class="text-muted"><%= @report.title.truncate(40) %></li>
<% end %>

<div class="mx-auto max-w-6xl">
  <div class="flex flex-wrap items-end justify-between gap-2">
    <div>
      <h1 class="text-base font-semibold text-body"><%= @report.title %></h1>
      <p class="mt-0.5 text-xs text-muted">
        <%= @template&.description %>
      </p>
    </div>
    <div class="flex items-center gap-1.5">
      <% if @report.completed? %>
        <%= link_to export_pdf_report_path(@report),
            class: "inline-flex min-h-[30px] items-center gap-1 rounded-md border border-theme bg-surface px-2.5 py-1 text-sm font-medium text-body hover:bg-[var(--color-border)]/30",
            data: { turbo: false } do %>
          <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          PDF
        <% end %>
        <%= link_to export_excel_report_path(@report),
            class: "inline-flex min-h-[30px] items-center gap-1 rounded-md border border-theme bg-surface px-2.5 py-1 text-sm font-medium text-body hover:bg-[var(--color-border)]/30",
            data: { turbo: false } do %>
          <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Excel
        <% end %>
      <% end %>
      <% if can? :destroy, @report %>
        <%= button_to "Delete", report_path(@report),
            method: :delete,
            class: "inline-flex min-h-[30px] items-center justify-center rounded-md border border-[var(--color-error-border)] px-2.5 py-1 text-sm font-medium text-[var(--color-error-text)] hover:bg-[var(--color-error-bg)]",
            data: { turbo_confirm: "Delete this report?" } %>
      <% end %>
    </div>
  </div>

  <%# ── Status / metadata ────────────────────────────────────────── %>
  <div class="mt-3 rounded-lg border border-theme bg-surface p-2.5">
    <div class="flex flex-wrap items-center gap-3 text-xs text-muted">
      <span>Status: <%= render_report_status_badge(@report) %></span>
      <span>Generated by: <strong class="text-body"><%= @report.generated_by.name || @report.generated_by.email_address %></strong></span>
      <span>Created: <strong class="text-body"><%= @report.created_at.strftime("%b %d, %Y %l:%M %p") %></strong></span>
      <% if @report.duration %>
        <span>Duration: <strong class="text-body"><%= "%.1f" % @report.duration %>s</strong></span>
      <% end %>
    </div>
  </div>

  <% if @report.pending? || @report.processing? %>
    <%# ── Processing state ────────────────────────────────────────── %>
    <div class="mt-2 rounded-lg border border-theme bg-surface p-6 text-center" data-controller="auto-refresh" data-auto-refresh-interval-value="3000">
      <div class="inline-flex items-center gap-2 text-sm text-muted">
        <svg class="h-5 w-5 animate-spin text-accent" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>
          <% if @report.pending? %>
            Report is queued for generation...
          <% else %>
            Report is being generated...
          <% end %>
        </span>
      </div>
      <p class="mt-2 text-xs text-muted">This page will refresh automatically.</p>
    </div>

  <% elsif @report.failed? %>
    <%# ── Failed state ────────────────────────────────────────────── %>
    <div class="mt-2 rounded-lg border border-[var(--color-error-border)] bg-[var(--color-error-bg)] p-2.5">
      <h2 class="text-sm font-semibold text-[var(--color-error-text)]">Report generation failed</h2>
      <p class="mt-0.5 text-xs text-[var(--color-error-text)]"><%= @report.error_message %></p>
    </div>

  <% elsif @report.completed? %>
    <% result = @report.result_data.deep_symbolize_keys %>

    <%# ── Summary ─────────────────────────────────────────────────── %>
    <% if result[:summary].present? %>
      <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-4">
        <% result[:summary].each do |key, value| %>
          <div class="rounded-lg border border-theme bg-surface p-2.5">
            <p class="text-xs text-muted"><%= key.to_s.titleize %></p>
            <p class="mt-0.5 text-lg font-semibold text-body"><%= value %></p>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# ── Chart ───────────────────────────────────────────────────── %>
    <% if result[:chart].present? %>
      <%# Handle multiple charts (nested structure) %>
      <% if result[:chart].values.first.is_a?(Hash) && result[:chart].values.first.key?(:datasets) %>
        <% result[:chart].each do |chart_name, chart_data| %>
          <div class="mt-2 rounded-lg border border-theme bg-surface p-2.5">
            <h2 class="text-sm font-semibold text-body"><%= chart_name.to_s.titleize %></h2>
            <div class="mt-2" style="height: 320px;">
              <canvas data-controller="report-chart"
                      data-report-chart-data-value="<%= chart_data.to_json %>"
                      data-report-chart-type-value="<%= @template&.chart_type || 'bar' %>">
              </canvas>
            </div>
          </div>
        <% end %>
      <% else %>
        <%# Single chart (flat structure) %>
        <div class="mt-2 rounded-lg border border-theme bg-surface p-2.5">
          <h2 class="text-sm font-semibold text-body">Chart</h2>
          <div class="mt-2" style="height: 320px;">
            <canvas data-controller="report-chart"
                    data-report-chart-data-value="<%= result[:chart].to_json %>"
                    data-report-chart-type-value="<%= @template&.chart_type || 'bar' %>">
            </canvas>
          </div>
        </div>
      <% end %>
    <% end %>

    <%# ── Data table ──────────────────────────────────────────────── %>
    <% if result[:table].present? && @template&.table_columns.present? %>
      <div class="mt-2 rounded-lg border border-theme bg-surface p-2.5">
        <h2 class="text-sm font-semibold text-body">Details</h2>
        <p class="mt-0.5 text-xs text-muted"><%= result[:table].size %> records</p>

        <div class="mt-2 overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-theme text-xs text-muted">
                <% @template.table_columns.each do |col| %>
                  <th class="pb-1.5 pr-3 font-medium"><%= col[:label] %></th>
                <% end %>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-border)]">
              <% result[:table].each do |row| %>
                <% row = row.symbolize_keys %>
                <tr>
                  <% @template.table_columns.each do |col| %>
                    <td class="py-1.5 pr-3 text-xs text-body">
                      <% if col[:key] == :order_number && row[:order_id].present? %>
                        <%= link_to row[col[:key].to_sym], order_path(row[:order_id]), class: "text-accent hover:underline" %>
                      <% else %>
                        <%= row[col[:key].to_sym] %>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <%# ── Held orders table (if present) ──────────────────────────── %>
    <% if result[:held_orders_table].present? && @template&.table_columns.present? %>
      <div class="mt-2 rounded-lg border border-[var(--color-warning-border)] bg-[var(--color-warning-bg)] p-2.5">
        <h2 class="text-sm font-semibold text-[var(--color-warning-text)]">Held Orders</h2>
        <p class="mt-0.5 text-xs text-[var(--color-warning-text)]">
          <%= result[:held_orders_table].size %> held orders with discounts (excluded from summary totals)
        </p>

        <div class="mt-2 overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead>
              <tr class="border-b border-[var(--color-warning-border)] text-xs text-[var(--color-warning-text)]">
                <% @template.table_columns.each do |col| %>
                  <th class="pb-1.5 pr-3 font-medium"><%= col[:label] %></th>
                <% end %>
              </tr>
            </thead>
            <tbody class="divide-y divide-[var(--color-warning-border)]">
              <% result[:held_orders_table].each do |row| %>
                <% row = row.symbolize_keys %>
                <tr>
                  <% @template.table_columns.each do |col| %>
                    <td class="py-1.5 pr-3 text-xs text-[var(--color-warning-text)]">
                      <% if col[:key] == :order_number && row[:order_id].present? %>
                        <%= link_to row[col[:key].to_sym], order_path(row[:order_id]), class: "text-[var(--color-warning-text)] hover:underline" %>
                      <% else %>
                        <%= row[col[:key].to_sym] %>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
